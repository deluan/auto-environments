#!/usr/bin/env ruby

require 'yaml'
Dir['./lib/*.rb'].each { |file| require file }

def configure(environment)
    ansible_project_base_dir = Pathname.new(ARGV[0]).realpath
    
    inventory_path = environment.create_localhost_inventory(InventoryFile.new(environment.domain, environment.name))
    playbook_path = environment.create_playbook(PlaybookFile.new(environment.domain, environment.name, "#{ansible_project_base_dir}/create.yml"))

    ansible_command = "ANSIBLE_ROLES_PATH=#{ansible_project_base_dir}/roles ansible-playbook #{playbook_path} -i #{inventory_path} -e \"app_user=petshop environment=#{environment.name}\""
    puts "\n**** Provisioning #{environment.name} ****\n\n"
    puts `#{ansible_command}`
end

Dir['./environments/*.yml'].each do |environment_filename|
    environment = Environment.new(File.new(environment_filename))
    configure(environment)
end
