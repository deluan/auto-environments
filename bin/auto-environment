#!/usr/bin/env ruby

require 'yaml'
Dir['./lib/*.rb'].each { |file| require file }

def configure(environment)
    inventory_path = environment.create_inventory(InventoryFile.new(environment.domain, environment.name))
    playbook_path = environment.create_playbook(PlaybookFile.new(environment.domain, environment.name))

    ansible_command = "ANSIBLE_ROLES_PATH=#{ARGV[0]}/roles ansible-playbook #{playbook_path} -i #{inventory_path} -u vagrant -e app_user=petshop"
    puts "\n**** Provisioning #{environment.name} ****\n\n"
    puts `#{ansible_command}`
end

Dir['./environments/*.yml'].each do |environment_filename|
    environment = Environment.new(File.new(environment_filename))
    configure(environment)
end
